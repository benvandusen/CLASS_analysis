---
title: "CLASS analysis"
author: "BVD"
date: "4/11/2019"
output: pdf_document
---

```{r message=FALSE, warning=FALSE}
load("~/pb_data")
load("~/all_class")
library(ltm)
#library(GPArotation)
library(itemanalysis)
library(psych)
library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)
plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.
```

Combine data

```{r}
pre_data <- as.data.frame(pb_data[c(2:4,6:7,9,11:31,33,35:41,43)], drop=false)
post_data <- as.data.frame(pb_data[c(46:48,50:51,53,55:75,77,79:85,87)], drop=false)
names(pre_data) <- c("q1","q2","q3","q5","q6","q8","q10","q11","q12","q13","q14","q15","q16","q17","q18","q19","q20","q21","q22","q23","q24","q25","q26","q27","q28","q29","q30","q32","q34","q35","q36","q37","q38","q39","q40","q42")
names(post_data) <- c("q1","q2","q3","q5","q6","q8","q10","q11","q12","q13","q14","q15","q16","q17","q18","q19","q20","q21","q22","q23","q24","q25","q26","q27","q28","q29","q30","q32","q34","q35","q36","q37","q38","q39","q40","q42")
all_data <- rbind(pre_data,post_data)
all_data = all_data[complete.cases(all_data),]
red_set <- c("q3","q5","q14","q21","q22","q23","q24","q25","q28","q29","q30","q32","q34","q37","q40")
red_data = all_data[red_set]
```

Item analysis all items
```{r}
item.analysis_all <- itemanalysis2(data=all_data,options=c(1,2,3,4,5),ngroup=37,correction=TRUE)
pbserial <- as.data.frame(item.analysis_all[["plots"]][[1]][["plot_env"]][["dist.disc"]])
names(pbserial) <- c("SD","D","N","A","SA")
pbserial$SD_D <- pbserial$D-pbserial$SD
pbserial$D_N <- pbserial$N-pbserial$D
pbserial$N_A <- pbserial$A-pbserial$N
pbserial$A_SA <- pbserial$SA-pbserial$A
dstat <- pbserial %>% summarise_all(funs(mean, sd))
#item.analysis_all$plots[[1]] #these are interesting. Similar to item difficulty plots
```

Item analysis reduced items
```{r}
item.analysis_red <- itemanalysis2(data=red_data,options=c(1,2,3,4,5),ngroup=37,correction=TRUE)
pbserial_red <- as.data.frame(item.analysis_red[["plots"]][[1]][["plot_env"]][["dist.disc"]])
names(pbserial_red) <- c("SD","D","N","A","SA")
pbserial_red$SD_D <- pbserial_red$D-pbserial_red$SD
pbserial_red$D_N <- pbserial_red$N-pbserial_red$D
pbserial_red$N_A <- pbserial_red$A-pbserial_red$N
pbserial_red$A_SA <- pbserial_red$SA-pbserial_red$A
dstat_red <- pbserial_red %>% summarise_all(funs(mean, sd))
#item.analysis_all$plots[[1]] #these are interesting. Similar to item difficulty plots
```

Alt scoring analysis
```{r}
all_data_alt <- all_data
all_data_alt[all_data_alt==2] <- 1
all_data_alt[all_data_alt==3] <- 1
all_data_alt[all_data_alt==4] <- 2
all_data_alt[all_data_alt==5] <- 3

item.analysis_alt <- itemanalysis2(data=all_data_alt, options=c(1,2,3),ngroup=37,correction=TRUE)
pbserial_alt <- as.data.frame(item.analysis_alt[["plots"]][[1]][["plot_env"]][["dist.disc"]])
names(pbserial_alt) <- c("SDN","A","SA")
pbserial_alt$N_A <- pbserial_alt$A-pbserial_alt$SDN
pbserial_alt$A_SA <- pbserial_alt$SA-pbserial_alt$A
dstat_alt <- pbserial_alt %>% summarise_all(funs(mean, sd))
```

plot
```{r}
multi.hist(pbserial,xlim=c(-0.5,0.5))
multi.hist(pbserial_red,xlim=c(-0.5,0.5))
```

factor analysis
```{r}
parallel <- fa.parallel(all_data, fm = 'minres', fa = 'fa')

onefactor <- fa(all_data,nfactors = 1,rotate = "oblimin",fm="minres")
print(onefactor)
print(onefactor$loadings,cutoff = 0.4)

twofactor <- fa(all_data,nfactors = 2,rotate = "oblimin",fm="minres") #Looks like the best most simple model (variance explained and questions maintained)
print(twofactor)
print(twofactor$loadings,cutoff = 0.4)

threefactor <- fa(all_data,nfactors = 3,rotate = "oblimin",fm="minres")
print(threefactor)
print(threefactor$loadings,cutoff = 0.4)

fourfactor <- fa(all_data,nfactors = 4,rotate = "oblimin",fm="minres")
print(fourfactor)
print(fourfactor$loadings,cutoff = 0.4)

fivefactor <- fa(all_data,nfactors = 5,rotate = "oblimin",fm="minres")
print(fivefactor)
print(fivefactor$loadings,cutoff = 0.4)

fa.diagram(onefactor)
fa.diagram(twofactor)
fa.diagram(threefactor)
fa.diagram(fourfactor)
```
