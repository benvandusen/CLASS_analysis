---
title: "HLM for LASSO Data updated for LASSO_data_1_19"
author: "Jayson Nissen"
date: "8/14/2018"
output: pdf_document
---

This has now been updated to run the CLASS Data post PERC.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(readr)
```

```{r}
load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Data Compilation/Combine/LASSO_data_6_19_for_research")
eq_data <- subset(temp, class_phys==1)
```

```{r load }


courses <- eq_data %>% group_by(course_id) %>% 
  summarise(N_total = length(course_id),
            N_pre = length(which(!is.na(e_pre))),
            N_post= length(which(!is.na(e_post))))

good_courses <- subset(courses, N_pre>7 &N_post>7)
#good_courses <- left_join(good_courses, unique(phys_ci[c(1,3)]), by = "assessment_sequence_id")


```


Figuring out the amount of missing pre and posttest data
```{r}
length(eq_data$e_pre[is.na(eq_data$e_pre)==TRUE]) / length(eq_data$e_pre)
length(eq_data$e_post[is.na(eq_data$e_post)==TRUE])/ length(eq_data$e_pre)
  
```




```{r student level}
#white or asian is Dom
eq_data$race_URM <- ifelse(eq_data$hispanic + eq_data$black + eq_data$american_indian + eq_data$hawaiian_or_other_pacific_islander + eq_data$race_other >=1,1,0)
#male is Dom
eq_data$gend_URM <- ifelse(eq_data$male==1,0,1)
# need to add row number to make each student unique
#temp <- subset(eq_data, course_id %in% course_info$course_id) # This does nothing
```



Organizing the race data more
```{r}
eq_data$black_no_int <- ifelse(eq_data$black==1,1,0)
eq_data$hispanic_no_int <- ifelse(eq_data$black==0& eq_data$hispanic==1,1,0)
eq_data$asian_no_int <- ifelse(eq_data$black==0& eq_data$hispanic==0 & eq_data$asian==1,1,0)
eq_data$amind_no_int <- ifelse(eq_data$black==0& eq_data$hispanic==0 & eq_data$asian==0 & eq_data$american_indian==1,1,0)
eq_data$pacisland_no_int <- ifelse(eq_data$black==0& eq_data$hispanic==0 & eq_data$asian==0 & eq_data$american_indian==0 & eq_data$hawaiian_or_other_pacific_islander==1 ,1,0)
eq_data$white_no_int <- ifelse(eq_data$black==0& eq_data$hispanic==0 & eq_data$asian==0 & eq_data$american_indian==0 & eq_data$hawaiian_or_other_pacific_islander==0 & eq_data$white==1 ,1,0)
eq_data$race_other_no_int <- ifelse(eq_data$black==0& eq_data$hispanic==0 & eq_data$asian==0 & eq_data$american_indian==0 & eq_data$hawaiian_or_other_pacific_islander==0 & eq_data$white==0 &  eq_data$race_other==1 ,1,0)

#Code to check that the no int categories do not overlap
eq_data$race_check <- with(eq_data,  black_no_int+ hispanic_no_int+ asian_no_int + amind_no_int + pacisland_no_int + white_no_int + race_other_no_int )
check <- eq_data[eq_data$race_check >1,]
unique(eq_data$race_check)

```

Summary statistics
```{r}

part_rat_all <- eq_data %>% summarise(N= length(e_pre),
                                                          pre_rat = 1-(sum(is.na(e_pre))/length(e_pre) ),
                                                          post_rat = 1-(sum(is.na(e_post))/length(e_pre) ))

part_rat <- eq_data %>% group_by(course_id) %>% summarise(N= length(e_pre),
                                                          pre_rat = 1-(sum(is.na(e_pre))/length(e_pre) ),
                                                          post_rat = 1-(sum(is.na(e_post))/length(e_pre) ))

low_participation <- part_rat$course_id[part_rat$pre_rat<0.39 | part_rat$post_rat<0.39]
eq_data <- subset(eq_data, !(eq_data$course_id %in% low_participation))

```

```{r}
sumstat_gend <- eq_data %>% group_by (male) %>% summarise(N= length(e_pre))
sumstat_race <- eq_data %>% group_by (hispanic, white, black, asian) %>% summarise(N= length(e_pre))
colnames(eq_data)
sumstat_intersect <- eq_data %>% group_by (hispanic_no_int, white_no_int, black_no_int, asian_no_int, gend_URM, amind_no_int, pacisland_no_int, race_other_no_int) %>% summarise(N= length(e_pre))

sumstat_intersect$race <- ifelse(sumstat_intersect$hispanic_no_int==1,"Hispanic",
                          ifelse(sumstat_intersect$white_no_int==1,"White",
                          ifelse(sumstat_intersect$black_no_int==1,"Black", 
                          ifelse(sumstat_intersect$asian_no_int==1,"Asian", 
                          ifelse(sumstat_intersect$amind_no_int ==1,"Indian", 
                          ifelse(sumstat_intersect$pacisland_no_int==1,"Hawaiian", 
                          ifelse( sumstat_intersect$race_other_no_int==1,"Other","unknown")) ) ))))


library(ggplot2)
ggplot(data=sumstat_intersect, aes(y=N, x=race, group=gend_URM, fill=as.character(gend_URM))) +geom_bar(stat = "identity", position="dodge")  + theme(axis.text.x = element_text(angle=90))

#demog <- sumstat_intersect[c(7,11:13)]
#demog$gender <- ifelse(demog$gend_URM %in% 1, "Female", "Male")
#I pout this below the figure so that I can get the more complete info before I reduce the number of variables
sumstat_intersect$race <- ifelse(sumstat_intersect$hispanic_no_int==1,"Hispanic",
                          ifelse(sumstat_intersect$white_no_int==1,"White",
                          ifelse(sumstat_intersect$black_no_int==1,"Black", 
                          ifelse(sumstat_intersect$asian_no_int==1,"Asian", "*Other") ) ))
unique(sumstat_intersect$race)
```




```{r}
length(unique(eq_data$course_id))
sum_gend <- eq_data %>% group_by(course_id) %>% summarize(gender_rep = mean(gend_URM, na.rm = TRUE))
eq_data <- left_join(eq_data,sum_gend, by="course_id")
eq_data$race <- ifelse(eq_data$hispanic_no_int==1,"Hispanic",
                          ifelse(eq_data$white_no_int==1,"White",
                          ifelse(eq_data$black_no_int==1,"Black", 
                          ifelse(eq_data$asian_no_int==1,"Asian", "*Other") ) ))

eq_data$race_otherstar_no_int <- 0
eq_data$race_otherstar_no_int[eq_data$race=="*Other"] <-1




colnames(eq_data)
eq_data_reduced <- eq_data[c(1:6,15:20,23:25,28,33)]
str(eq_data_reduced)
save(eq_data_reduced, file="eq_data_4_17_19")
```

```{r}
library(hmi)
library(mice)

load(file="eq_data_4_17_19")

eq_data_reduced <- as.data.frame(eq_data_reduced)
eq_data_reduced$course_use_la[is.na(eq_data_reduced$course_use_la ) ==TRUE] <- 1 
eq_data_reduced$course_use_la <- as.numeric(eq_data_reduced$course_use_la)

eq_data_reduced$collab_learning_during_class <- as.numeric(eq_data_reduced$collab_learning_during_class)
#eq_data_reduced$intercept <- 1
colnames(eq_data_reduced)



course_descriptions_updated <- read.csv("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/CLASS Analysis/course_descriptions_updated.csv")
courses <- unique(course_descriptions_updated[c(1:3)])
eq_data_reduced <- left_join(eq_data_reduced, courses, by="course_id")

unique(eq_data_reduced$math)
eq_data_reduced$math[eq_data_reduced$math=="other"] <- "algebra"
temp3 <- eq_data_reduced[eq_data_reduced$math=="other",]
unique(eq_data_reduced_2$level)
eq_data_reduced <- subset(eq_data_reduced, level %in% c("1","2","other"))

colnames(eq_data_reduced_2)

rm(hmi_4_17_19)
hmi_4_19_19 <- hmi(eq_data_reduced, model_formula = e_post ~ 1 + e_pre + male + black_no_int + hispanic_no_int + asian_no_int + race_otherstar_no_int + math + level + (1|course_id)  , M = 10, maxit = 5, nitt = 3000,  burnin = 1000)

# running it with the race variables and first_time causes it to not converge.

save(hmi_4_19_19, file="hmi_4_21_19")
```




HLM Analysis
```{r message=FALSE, warning=FALSE}
#load("~/hmi_data_1_10_19")
#load("~/Physics_Equity/hmifall2018_m10_better")
#load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")
load("hmi_4_21_19")
library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)
plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.
```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_4_19_19) #converts file type
thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  temp <- temp[temp$level!=2,]
  #temp <- temp[temp$course_id!="531",] # This is a small course that is throwing off the class means -- outlier
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(e_pre))
  class_means$class_pre_cent <- class_means$pre_mean_class - mean(class_means$pre_mean_class)
  temp <- left_join(temp,class_means, by="course_id")
  temp$stud_pre_cent <- temp$e_pre - temp$pre_mean_class
  temp$gain <- temp$e_post - temp$e_pre
  temp$course_type <- ifelse(temp$math=="algebra" & temp$level=="1","algmech",ifelse(temp$math=="calculus" & temp$level=="1","calcmech",ifelse(temp$math=="algebra" & temp$level=="2","algenm",ifelse(temp$math=="calculus" & temp$level=="2","calcenm","other"))))
  #temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse(temp$first_time==1,0,1)
  #temp$race_otherstar_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
  temp$female <- ifelse(temp$male==1,0,1)
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
  
#as_courses <- unique(temp$course_id)
#save(as_courses, file="as_courses")

```

#Descriptive statistics by lecture and gender
```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$pacisland_no_int ==1, "Island",ifelse(temp$race_otherstar_no_int ==1, "Other","White")))))
desc <- temp %>% group_by(collab_learning_during_class, male) %>% summarise(N = length(e_pre),
                                                                 pre_mean = mean(e_pre),
                                                                 pre_sd = sd(e_pre),
                                                                 post_mean = mean(e_post),
                                                                 post_sd = sd(e_post),
                                                                 gain_mean = mean (e_post-e_pre),
                                                                 gain_sd = sd(e_post-e_pre)
                                                                 )


return <- desc
}
desc <- desc2 %>% group_by(collab_learning_during_class, male) %>% summarise_all(funs(mean))
desc$collab_learning_during_class <- ifelse(desc$collab_learning_during_class == 0, "Lecture","Collaborative")
desc$male <- ifelse(desc$male==0, "Female","Male")
kable(desc, digits=1)
```

#Descriptive statistics by lecture

Updated to here.
```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$pacisland_no_int ==1, "Island",ifelse(temp$race_otherstar_no_int ==1, "Other","White")))))
desc <- temp  %>% summarise(N = length(e_pre),
                                                                 pre_mean = mean(e_pre),
                                                                 pre_sd = sd(e_pre),
                                                                 post_mean = mean(e_post),
                                                                 post_sd = sd(e_post),
                                                                 gain_mean = mean (e_post-e_pre),
                                                                 gain_sd = sd(e_post-e_pre)
                                                                 )


return <- desc
}
desc <- desc2 %>% summarise_all(funs(mean))
#desc$lecture <- ifelse(desc$lecture ==1, "Lecture","Collaborative")
#desc$male <- ifelse(desc$male==1, "Female","Male")
kable(desc, digits=1)
```

#Descriptive statistics by lecture, race and gender
```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$race_otherstar_no_int ==1, "Other","White"))))
desc <- temp %>% group_by( collab_learning_during_class, race, male) %>% summarise(N = length(e_pre),
                                                                 pre_mean = mean(e_pre),
                                                                 pre_sd = sd(e_pre),
                                                                 post_mean = mean(e_post),
                                                                 post_sd = sd(e_post),
                                                                 gain_mean = mean (e_post-e_pre),
                                                                 gain_sd = sd(e_post-e_pre)
                                                                 )


return <- desc
}
desc <- desc2 %>% group_by(race, collab_learning_during_class, male) %>% summarise_all(funs(mean))
desc$collab_learning_during_class <- ifelse(desc$collab_learning_during_class ==0, "Lecture","Collaborative")
desc$male <- ifelse(desc$male==0, "Female","Male")
kable(desc, digits=1)
#sum(temp$hispanic_no_int)
#length(temp[temp$his])

```

```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$race_otherstar_no_int ==1, "Other","White"))))
desc <- temp %>% group_by(math, level, race, male) %>% summarise(N = length(e_pre),
                                                                 pre_mean = mean(e_pre),
                                                                 pre_sd = sd(e_pre),
                                                                 post_mean = mean(e_post),
                                                                 post_sd = sd(e_post),
                                                                 gain_mean = mean (e_post-e_pre),
                                                                 gain_sd = sd(e_post-e_pre)
                                                                 )


return <- desc
}
desc <- desc2 %>% group_by(race, math, level, male) %>% summarise_all(funs(mean))
#desc$collab_learning_during_class <- ifelse(desc$collab_learning_during_class ==0, "Lecture","Collaborative")
desc$male <- ifelse(desc$male==0, "Female","Male")
kable(desc, digits=1)
#sum(temp$hispanic_no_int)
#length(temp[temp$his])

```

```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$race_otherstar_no_int ==1, "Other","White"))))
desc <- temp %>% group_by(math, level) %>% summarise(N = length(e_pre),
                                                                 pre_mean = mean(e_pre),
                                                                 pre_sd = sd(e_pre),
                                                                 post_mean = mean(e_post),
                                                                 post_sd = sd(e_post),
                                                                 gain_mean = mean (e_post-e_pre),
                                                                 gain_sd = sd(e_post-e_pre)
                                                                 )


return <- desc
}
desc <- desc2 %>% group_by(math, level) %>% summarise_all(funs(mean))
#desc$collab_learning_during_class <- ifelse(desc$collab_learning_during_class ==0, "Lecture","Collaborative")
#desc$male <- ifelse(desc$male==0, "Female","Male")
kable(desc, digits=1)
#sum(temp$hispanic_no_int)
#length(temp[temp$his])

```

```{r }
e_post1 <- with(MIdata,{lmer(e_post~1 + (1|course_id))})
aic.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + (1|course_id))
  return <- AIC(mod_aic)
}
e_post1.1 <- with(MIdata,{lmer(e_post~1 + course_type + (1|course_id))})
aic.1.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + course_type + (1|course_id))
  return <- AIC(mod_aic)
}
e_post1.2 <- with(MIdata,{lmer(e_post~1 + course_type + stud_pre_cent +  (1 |course_id))})
aic.1.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + course_type + stud_pre_cent + (1|course_id))
  return <- AIC(mod_aic)
  }
e_post2 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent + (1|course_id))})
aic.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent + (1|course_id))
  return <- AIC(mod_aic)
  }
e_post3 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + (1|course_id))})
aic.3 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + (1|course_id))
  return <- AIC(mod_aic)
}
e_post3.1 <- with(MIdata,{lmer(e_post~1 + class_pre_cent + (1|course_id))})
aic.3.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + class_pre_cent + (1|course_id))
  return <- AIC(mod_aic)
}
e_post3.2 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (1|course_id))})
aic.3.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (1|course_id))
  return <- AIC(mod_aic)
}
e_post4 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent + female + (1|course_id))})
aic.4 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + female + (1|course_id))
  return <- AIC(mod_aic)
}
e_post4.1 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type + female + (1|course_id))})
aic.4.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + female + (1|course_id))
  return <- AIC(mod_aic)
}
e_post4.2 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female + (1|course_id))})
aic.4.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female + (1|course_id))
  return <- AIC(mod_aic)
}

e_post4.3 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))})
aic.4.3 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))
  return <- AIC(mod_aic)
}
e_post4.4 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))})
aic.4.4 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))
  return <- AIC(mod_aic)
}
e_post4.5 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class +  (1|course_id))})
aic.4.5 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class + (1|course_id))
  return <- AIC(mod_aic)
}
gain4.6 <- with(MIdata,{lmer(gain~1 + stud_pre_cent  + class_pre_cent + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class +  (1|course_id))})



e_post5 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +  (1|course_id))})
aic.5 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))
  return <- AIC(mod_aic)
  }
e_post6 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class + (1|course_id))})
aic.6 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post ~ 1 + stud_pre_cent  + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class + (1|course_id))
  return <- AIC(mod_aic)
  }
e_post7 <- with(MIdata,{lmer(e_post~1 + collab_learning_during_class*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int)*female + stud_pre_cent  + (1|course_id))})
aic.7 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post ~ 1 + collab_learning_during_class*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int)*female + stud_pre_cent  + (1|course_id))
  return <- AIC(mod_aic)
  }

e_post8 <- with(MIdata,{lmer(e_post~1 + collab_learning_during_class + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + female + stud_pre_cent  + class_pre_cent + (1|course_id))})
aic.8 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + collab_learning_during_class + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + female + stud_pre_cent  + class_pre_cent + (1|course_id))
  return <- AIC(mod_aic)
  }
e_post9 <- with(MIdata,{lmer(e_post~1  + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + female +  (1|course_id))})
aic.9 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1  + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + female +  (1|course_id))
  return <- AIC(mod_aic)
  }




pre1 <- with(MIdata,{lmer(e_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))})
aic.pre.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +  (1|course_id))
  return <- AIC(mod_aic)
  }
pre2 <- with(MIdata,{lmer(e_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class + (1|course_id))})
aic.pre.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + collab_learning_during_class + (1|course_id))
  return <- AIC(mod_aic)
  }
pre3 <- with(MIdata,{lmer(e_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + course_type +(1|course_id))})
aic.pre3 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + course_type +  (1|course_id))
  return <- AIC(mod_aic)
  }
pre4 <- with(MIdata,{lmer(l_pre~1 + female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + course_type +(1|course_id))})
aic.pre4 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post ~  (1|course_id))
  return <- AIC(mod_aic)
  }
```

```{r}
info_crit <- as.data.frame(cbind(aic.1, aic.1.1,aic.1.2,aic.2,aic.3,aic.3.1,aic.3.2,aic.4,aic.4.1,aic.4.2,aic.4.3,aic.4.4,aic.4.5,aic.5,aic.6,aic.7,aic.8,aic.9))
#info_crit[11,] <- colMeans(info_crit)

colnames(info_crit) <- c("aic.1", "aic.1.1","aic.1.2","aic.2","aic.3","aic.3.1","aic.3.2", "aic.4","aic.4.1","aic.4.2","aic.4.3","aic.4.4","aic.4.5","aic.5","aic.6","aic.7","aic.8","aic.9")

temp <- as.data.frame(colMeans(info_crit))
temp$delta <- temp$`colMeans(info_crit)`- min(temp$`colMeans(info_crit)`)

barplot(temp$delta)
```


```{r echo=FALSE}
testEstimates(e_post1, var.comp=TRUE)
testEstimates(e_post1.1, var.comp=TRUE)
testEstimates(e_post1.2, var.comp=TRUE)
testEstimates(e_post2, var.comp=TRUE)
testEstimates(e_post3, var.comp=TRUE)
testEstimates(e_post3.1, var.comp=TRUE)
testEstimates(e_post4, var.comp=TRUE)
testEstimates(e_post4.1, var.comp=TRUE)
testEstimates(e_post4.2, var.comp=TRUE)
testEstimates(e_post4.3, var.comp=TRUE)
testEstimates(e_post4.4, var.comp=TRUE)
testEstimates(e_post4.5, var.comp=TRUE)
testEstimates(gain4.6, var.comp=TRUE)

testEstimates(e_post5, var.comp=TRUE)
testEstimates(e_post6, var.comp=TRUE)
testEstimates(e_post7, var.comp=TRUE)
testEstimates(e_post8, var.comp=TRUE)
testEstimates(e_post9, var.comp=TRUE)

testEstimates(pre1, var.comp=TRUE)
testEstimates(pre2, var.comp=TRUE)
testEstimates(pre3, var.comp=TRUE)
testEstimates(pre4, var.comp=TRUE)
```


Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_4_19_19) #converts file type
thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  #temp <- temp[temp$level!=2,]
  #temp <- temp[temp$math!="other",]
  #temp <- temp[temp$course_id!="531",] # This is a small course that is throwing off the class means -- outlier
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(e_pre))
  class_means$class_pre_cent <- class_means$pre_mean_class - mean(class_means$pre_mean_class)
  temp <- left_join(temp,class_means, by="course_id")
  temp$stud_pre_cent <- temp$e_pre - temp$pre_mean_class
  temp$gain <- temp$e_post - temp$e_pre
  temp$course_type <- ifelse(temp$math=="algebra" & temp$level=="1","algmech",ifelse(temp$math=="calculus" & temp$level=="1","calcmech",ifelse(temp$math=="algebra" & temp$level=="2","algenm",ifelse(temp$math=="calculus" & temp$level=="2","calcenm","other"))))
  #temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse(temp$first_time==1,0,1)
  #temp$race_otherstar_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
  temp$female <- ifelse(temp$male==1,0,1)
  temp <- subset(temp, course_type=="algmech" | course_type=="calcmech")
  
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
  
#as_courses <- unique(temp$course_id)
#save(as_courses, file="as_courses")

```

This is just to run it all with no interactions in the models to simplify everything.
```{r}
e_pre1 <- with(MIdata,{lmer(e_pre~1 + (1|course_id))})
aic.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1 + (1|course_id))
  return <- AIC(mod_aic)
}

e_pre2 <- with(MIdata,{lmer(e_pre~1 + course_type + (1|course_id))})
aic.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1 + course_type + (1|course_id))
  return <- AIC(mod_aic)
}

e_pre3 <- with(MIdata,{lmer(e_pre~1  + course_type + female + (1|course_id))})
aic.3 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1  + course_type + female + (1|course_id))
  return <- AIC(mod_aic)
}

e_pre4 <- with(MIdata,{lmer(e_pre~1  + course_type + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))})
aic.4 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1  + course_type + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))
  return <- AIC(mod_aic)
}

e_pre5 <- with(MIdata,{lmer(e_pre~1  + course_type + female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))})
aic.5 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1  + course_type + female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))
  return <- AIC(mod_aic)
}

e_pre6 <- with(MIdata,{lmer(e_pre~1  + course_type*collab_learning_during_class +  female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))})
aic.6 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1  + course_type*collab_learning_during_class +  female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))
  return <- AIC(mod_aic)
}

e_pre7 <- with(MIdata,{lm(e_pre~1  + course_type + female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) )})


info_crit <- as.data.frame(cbind(aic.1,aic.2,aic.3,aic.4,aic.5))
#info_crit[11,] <- colMeans(info_crit)

colnames(info_crit) <- c("aic.1", "aic.2","aic.3","aic.4","aic.5")

ics <- as.data.frame(colMeans(info_crit))
ics$delta <- ics$`colMeans(info_crit)`- min(ics$`colMeans(info_crit)`)

barplot(ics$delta)

testEstimates(e_pre1, var.comp=TRUE)
testEstimates(e_pre2, var.comp=TRUE)
testEstimates(e_pre3, var.comp=TRUE)
testEstimates(e_pre4, var.comp=TRUE)
testEstimates(e_pre5, var.comp=TRUE)
testEstimates(e_pre7, var.comp=TRUE)
```

This is just to run it all with no interactions in the models to simplify everything.
```{r}
e_post1 <- with(MIdata,{lmer(e_post~1 + (1|course_id))})
aic.1 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + (1|course_id))
  return <- AIC(mod_aic)
}

e_post2 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + (1|course_id))})
aic.2 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + (1|course_id))
  return <- AIC(mod_aic)
}

e_post3 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (1|course_id))})
aic.3 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (1|course_id))
  return <- AIC(mod_aic)
}

e_post4 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type + female + (1|course_id))})
aic.4 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + female + (1|course_id))
  return <- AIC(mod_aic)
}

e_post5 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))})
aic.5 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) +(1|course_id))
  return <- AIC(mod_aic)
}

e_post6 <- with(MIdata,{lmer(e_post~1 + stud_pre_cent  + class_pre_cent + course_type + female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))})
aic.5 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (asian_no_int + black_no_int + hispanic_no_int+ race_otherstar_no_int) + female + (1|course_id))
  return <- AIC(mod_aic)
}

e_pre7 <- with(MIdata,{lmer(e_pre~1  + course_type + female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))})

e_post7 <- with(MIdata,{lmer(e_post~1 + course_type + female + (asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))})
aic.5 <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + stud_pre_cent  + class_pre_cent + course_type + (asian_no_int + black_no_int + hispanic_no_int+ race_otherstar_no_int) + female + (1|course_id))
  return <- AIC(mod_aic)
}

info_crit <- as.data.frame(cbind(aic.1,aic.2,aic.3,aic.4,aic.5,aic.6))
#info_crit[11,] <- colMeans(info_crit)

colnames(info_crit) <- c("aic.1", "aic.2","aic.3","aic.4","aic.5","aic.6")

ics <- as.data.frame(colMeans(info_crit))
ics$delta <- ics$`colMeans(info_crit)`- min(ics$`colMeans(info_crit)`)

barplot(ics$delta)

testEstimates(e_post1, var.comp=TRUE)
testEstimates(e_post2, var.comp=TRUE)
testEstimates(e_post3, var.comp=TRUE)
testEstimates(e_post4, var.comp=TRUE)
testEstimates(e_post5, var.comp=TRUE)
testEstimates(e_post6, var.comp=TRUE)

testEstimates(e_pre7, var.comp=TRUE)
testEstimates(e_post7, var.comp=TRUE)
```

```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```

mod_pre_1 <- pre_score~1 + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)

```{r}
#     c(I, C,F, A,B,H,O)
WMA = c(1, 0,0, 0,0,0,0)
AMA = c(1, 0,0, 1,0,0,0)
BMA = c(1, 0,0, 0,1,0,0)
HMA = c(1, 0,0, 0,0,1,0)
OMA = c(1, 0,0, 0,0,0,1)
WMC = c(1, 1,0, 0,0,0,0)
AMC = c(1, 1,0, 1,0,0,0)
BMC = c(1, 1,0, 0,1,0,0)
HMC = c(1, 1,0, 0,0,1,0)
OMC = c(1, 1,0, 0,0,0,1)
WFA = c(1, 0,1, 0,0,0,0)
AFA = c(1, 0,1, 1,0,0,0)
BFA = c(1, 0,1, 0,1,0,0)
HFA = c(1, 0,1, 0,0,1,0)
OFA = c(1, 0,1, 0,0,0,1)
WFC = c(1, 1,1, 0,0,0,0)
AFC = c(1, 1,1, 1,0,0,0)
BFC = c(1, 1,1, 0,1,0,0)
HFC = c(1, 1,1, 0,0,1,0)
OFC = c(1, 1,1, 0,0,0,1)

cf_e_pre_7 <- rbind('White Male Algebra'=WMA,  
                          'White Female Algebra'=WFA,
                          'Black Male Algebra'=BMA,  
                          'Black Female Algebra'=BFA,
                          'Asian Male Algebra'=AMA, 
                          'Asian Female Algebra'=AFA,
                          'Hispanic Male Algebra'=HMA, 
                          'Hispanic Female Algebra'=HFA,
                          'Other Male Algebra'=OMA,  
                          'Other Female Algebra'=OFA,
                          'White Male Calculus'=WMC,  
                          'White Female Calculus'=WFC,
                          'Black Male Calculus'=BMC,  
                          'Black Female Calculus'=BFC,
                          'Asian Male Calculus'=AMC, 
                          'Asian Female Calculus'=AFC,
                          'Hispanic Male Calculus'=HMC, 
                          'Hispanic Female Calculus'=HFC,
                          'Other Male Calculus'=OMC,  
                          'Other Female Calculus'=OFC)

contrast_p7_est <- pool_and_cov_diffwm(e_pre7,cf_e_pre_7)
unique(contrast_p7_est$race)

contrast_p7_est$race <- factor(contrast_p7_est$race, levels = c("Black", "Hispanic", "Other", "Asian",    "White"))

ggplot(data=contrast_p7_est, aes(x=race, y=Q, group=gender, color=gender)) + geom_point(position = position_dodge(width=0.90)) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Pretest (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))


ggsave("~pre7.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_p7_est[c(1,2,6,7)], digits = 2)
```

```{r}
#     c(I, C,F, A,B,H,O)
WMA = c(1, 0,0, 0,0,0,0)
AMA = c(1, 0,0, 1,0,0,0)
BMA = c(1, 0,0, 0,1,0,0)
HMA = c(1, 0,0, 0,0,1,0)
OMA = c(1, 0,0, 0,0,0,1)
WMC = c(1, 1,0, 0,0,0,0)
AMC = c(1, 1,0, 1,0,0,0)
BMC = c(1, 1,0, 0,1,0,0)
HMC = c(1, 1,0, 0,0,1,0)
OMC = c(1, 1,0, 0,0,0,1)
WFA = c(1, 0,1, 0,0,0,0)
AFA = c(1, 0,1, 1,0,0,0)
BFA = c(1, 0,1, 0,1,0,0)
HFA = c(1, 0,1, 0,0,1,0)
OFA = c(1, 0,1, 0,0,0,1)
WFC = c(1, 1,1, 0,0,0,0)
AFC = c(1, 1,1, 1,0,0,0)
BFC = c(1, 1,1, 0,1,0,0)
HFC = c(1, 1,1, 0,0,1,0)
OFC = c(1, 1,1, 0,0,0,1)

cf_e_post_7 <- rbind('White Male Algebra'=WMA,  
                          'White Female Algebra'=WFA,
                          'Black Male Algebra'=BMA,  
                          'Black Female Algebra'=BFA,
                          'Asian Male Algebra'=AMA, 
                          'Asian Female Algebra'=AFA,
                          'Hispanic Male Algebra'=HMA, 
                          'Hispanic Female Algebra'=HFA,
                          'Other Male Algebra'=OMA,  
                          'Other Female Algebra'=OFA,
                          'White Male Calculus'=WMC,  
                          'White Female Calculus'=WFC,
                          'Black Male Calculus'=BMC,  
                          'Black Female Calculus'=BFC,
                          'Asian Male Calculus'=AMC, 
                          'Asian Female Calculus'=AFC,
                          'Hispanic Male Calculus'=HMC, 
                          'Hispanic Female Calculus'=HFC,
                          'Other Male Calculus'=OMC,  
                          'Other Female Calculus'=OFC)

contrast_post7_est <- pool_and_cov_diffwm(e_post7,cf_e_post_7)
unique(contrast_post7_est$race)

contrast_post7_est$race <- factor(contrast_post7_est$race, levels = c("Black", "Hispanic", "Other", "Asian",    "White"))

ggplot(data=contrast_post7_est, aes(x=race, y=Q, group=gender, color=gender)) + geom_point(position = position_dodge(width=0.90)) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Pretest (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))


ggsave("~pre7.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_p7_est[c(1,2,6,7)], digits = 2)
```

```{r}

contrast_post7_est$time <- "Post"
contrast_p7_est$time <- "Pre"
for_plot <- rbind(contrast_post7_est,contrast_p7_est)
for_plot$Time <- factor(for_plot$time, levels=c("Pre","Post")) 
for_plot$gender_time <- paste(for_plot$Time, for_plot$gender)
for_plot$gender_time <- factor(for_plot$gender_time, levels=c("Pre Female","Pre Male","Post Female","Post Male"))

ggplot(data=for_plot, aes(x=race, y=Q, group=gender_time, color=gender, shape=Time)) + geom_point(position = position_dodge(width=0.90), size=2) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Expert-like Score (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))

```


```{r}
 
models <- c("e_pre1","e_pre2","e_pre3","e_pre4","e_pre5","e_pre6")
mod_var_tab <- data_frame(model = NA,
                          level2 = NA,
                          level1 = NA,
                          ICC = NA)
for(i in 1:6){
  temp <- testEstimates(get(models[i]), var.comp=TRUE)
  mod_var_tab[i,1] <- models[i]
  mod_var_tab[i,2] <- temp$var.comp[1]
  mod_var_tab[i,3] <- temp$var.comp[2]
  mod_var_tab[i,4] <- temp$var.comp[3]
  }
mod_var_tab$lvl1change <- (mod_var_tab$level1[1]- mod_var_tab$level1)/mod_var_tab$level1[1]
mod_var_tab$lvl2change <- (mod_var_tab$level2[1]- mod_var_tab$level2)/mod_var_tab$level2[1]

temp_mod <- mod_var_tab

models <- c("e_post1","e_post3","e_post3","e_post4","e_post3","e_post6","e_post8")
mod_var_tab <- data_frame(model = NA,
                          level2 = NA,
                          level1 = NA,
                          ICC = NA)
for(i in 1:5){
  temp <- testEstimates(get(models[i]), var.comp=TRUE)
  mod_var_tab[i,1] <- models[i]
  mod_var_tab[i,2] <- temp$var.comp[1]
  mod_var_tab[i,3] <- temp$var.comp[2]
  mod_var_tab[i,4] <- temp$var.comp[3]
  }
mod_var_tab$lvl1change <- (mod_var_tab$level1[1]- mod_var_tab$level1)/mod_var_tab$level1[1]
mod_var_tab$lvl2change <- (mod_var_tab$level2[1]- mod_var_tab$level2)/mod_var_tab$level2[1]

temp2 <- rbind(temp_mod, mod_var_tab)
```



Stuff I probablly won't use.


```{r}
#     c(I,P,P  C,F, A,B,H,O)
WMA = c(1,0,0, 0,0, 0,0,0,0)
AMA = c(1,0,0, 0,0, 1,0,0,0)
BMA = c(1,0,0, 0,0, 0,1,0,0)
HMA = c(1,0,0, 0,0, 0,0,1,0)
OMA = c(1,0,0, 0,0, 0,0,0,1)
WMC = c(1,0,0, 1,0, 0,0,0,0)
AMC = c(1,0,0, 1,0, 1,0,0,0)
BMC = c(1,0,0, 1,0, 0,1,0,0)
HMC = c(1,0,0, 1,0, 0,0,1,0)
OMC = c(1,0,0, 1,0, 0,0,0,1)
WFA = c(1,0,0, 0,1, 0,0,0,0)
AFA = c(1,0,0, 0,1, 1,0,0,0)
BFA = c(1,0,0, 0,1, 0,1,0,0)
HFA = c(1,0,0, 0,1, 0,0,1,0)
OFA = c(1,0,0, 0,1, 0,0,0,1)
WFC = c(1,0,0, 1,1, 0,0,0,0)
AFC = c(1,0,0, 1,1, 1,0,0,0)
BFC = c(1,0,0, 1,1, 0,1,0,0)
HFC = c(1,0,0, 1,1, 0,0,1,0)
OFC = c(1,0,0, 1,1, 0,0,0,1)

cf_e_post6 <- rbind('White Male Algebra'=WMA,  
                          'White Female Algebra'=WFA,
                          'Black Male Algebra'=BMA,  
                          'Black Female Algebra'=BFA,
                          'Asian Male Algebra'=AMA, 
                          'Asian Female Algebra'=AFA,
                          'Hispanic Male Algebra'=HMA, 
                          'Hispanic Female Algebra'=HFA,
                          'Other Male Algebra'=OMA,  
                          'Other Female Algebra'=OFA,
                          'White Male Calculus'=WMC,  
                          'White Female Calculus'=WFC,
                          'Black Male Calculus'=BMC,  
                          'Black Female Calculus'=BFC,
                          'Asian Male Calculus'=AMC, 
                          'Asian Female Calculus'=AFC,
                          'Hispanic Male Calculus'=HMC, 
                          'Hispanic Female Calculus'=HFC,
                          'Other Male Calculus'=OMC,  
                          'Other Female Calculus'=OFC)

contrast_post6_est <- pool_and_cov_diffwm(e_post6,cf_e_post6)
unique(contrast_post6_est$race)

contrast_post6_est$race <- factor(contrast_post6_est$race, levels = c("Black", "Hispanic", "Other", "Asian",    "White"))

ggplot(data=contrast_post6_est, aes(x=race, y=Q, group=gender, color=gender)) + geom_point(position = position_dodge(width=0.90)) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Posttest (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))


ggsave("~post6.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_p7_est[c(1,2,6,7)], digits = 2)
```






Stuff
The posttest models with interactions
```{r}
e_postX <- with(MIdata,{lmer(e_post~1 + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))})
aic.X <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_post~1 + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))
  return <- AIC(mod_aic)
}

testEstimates(e_postX, var.comp=TRUE)

#     c(I,C, F,A,B,H,O, cf,ca,cb,ch,co, fa,fb,fh,fo, cfa,cfb,cfh,cfo)
WMA = c(1,0, 0,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AMA = c(1,0, 0,1,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
BMA = c(1,0, 0,0,1,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
HMA = c(1,0, 0,0,0,1,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
OMA = c(1,0, 0,0,0,0,1,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)

WMC = c(1,1, 0,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AMC = c(1,1, 0,1,0,0,0,  0, 1, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
BMC = c(1,1, 0,0,1,0,0,  0, 0, 1, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
HMC = c(1,1, 0,0,0,1,0,  0, 0, 0, 1, 0,  0, 0, 0, 0,   0,  0,  0,  0)
OMC = c(1,1, 0,0,0,0,1,  0, 0, 0, 0, 1,  0, 0, 0, 0,   0,  0,  0,  0)

WFA = c(1,0, 1,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AFA = c(1,0, 1,1,0,0,0,  0, 0, 0, 0, 0,  1, 0, 0, 0,   0,  0,  0,  0)
BFA = c(1,0, 1,0,1,0,0,  0, 0, 0, 0, 0,  0, 1, 0, 0,   0,  0,  0,  0)
HFA = c(1,0, 1,0,0,1,0,  0, 0, 0, 0, 0,  0, 0, 1, 0,   0,  0,  0,  0)
OFA = c(1,0, 1,0,0,0,1,  0, 0, 0, 0, 0,  0, 0, 0, 1,   0,  0,  0,  0)

WFC = c(1,1, 1,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AFC = c(1,1, 1,1,0,0,0,  0, 1, 0, 0, 0,  1, 0, 0, 0,   1,  0,  0,  0)
BFC = c(1,1, 1,0,1,0,0,  0, 0, 1, 0, 0,  0, 1, 0, 0,   0,  1,  0,  0)
HFC = c(1,1, 1,0,0,1,0,  0, 0, 0, 1, 0,  0, 0, 1, 0,   0,  0,  1,  0)
OFC = c(1,1, 1,0,0,0,1,  0, 0, 0, 0, 1,  0, 0, 0, 1,   0,  0,  0,  1)


cf_e_postX <- rbind('White Male Algebra'=WMA,  
                          'White Female Algebra'=WFA,
                          'Black Male Algebra'=BMA,  
                          'Black Female Algebra'=BFA,
                          'Asian Male Algebra'=AMA, 
                          'Asian Female Algebra'=AFA,
                          'Hispanic Male Algebra'=HMA, 
                          'Hispanic Female Algebra'=HFA,
                          'Other Male Algebra'=OMA,  
                          'Other Female Algebra'=OFA,
                          'White Male Calculus'=WMC,  
                          'White Female Calculus'=WFC,
                          'Black Male Calculus'=BMC,  
                          'Black Female Calculus'=BFC,
                          'Asian Male Calculus'=AMC, 
                          'Asian Female Calculus'=AFC,
                          'Hispanic Male Calculus'=HMC, 
                          'Hispanic Female Calculus'=HFC,
                          'Other Male Calculus'=OMC,  
                          'Other Female Calculus'=OFC)

contrast_postX_est <- pool_and_cov_diffwm(e_postX,cf_e_postX)
unique(contrast_postX_est$race)

contrast_postX_est$race <- factor(contrast_postX_est$race, levels = c("Black", "Hispanic", "Other", "Asian",    "White"))

ggplot(data=contrast_postX_est, aes(x=race, y=Q, group=gender, color=gender)) + geom_point(position = position_dodge(width=0.90)) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Posttest (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))

```

This section runs the pretest modes with interactions.
```{r}
e_preX <- with(MIdata,{lmer(e_pre~1 + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))})
aic.X <- foreach(i=1:10, .combine=rbind) %do% {
  mod_aic <- lmer(data=MIdata[[i]], e_pre~1 + course_type*female*(asian_no_int + black_no_int + hispanic_no_int + race_otherstar_no_int) + (1|course_id))
  return <- AIC(mod_aic)
}

testEstimates(e_preX, var.comp=TRUE)

#     c(I,C, F,A,B,H,O, cf,ca,cb,ch,co, fa,fb,fh,fo, cfa,cfb,cfh,cfo)
WMA = c(1,0, 0,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AMA = c(1,0, 0,1,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
BMA = c(1,0, 0,0,1,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
HMA = c(1,0, 0,0,0,1,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
OMA = c(1,0, 0,0,0,0,1,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)

WMC = c(1,1, 0,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AMC = c(1,1, 0,1,0,0,0,  0, 1, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
BMC = c(1,1, 0,0,1,0,0,  0, 0, 1, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
HMC = c(1,1, 0,0,0,1,0,  0, 0, 0, 1, 0,  0, 0, 0, 0,   0,  0,  0,  0)
OMC = c(1,1, 0,0,0,0,1,  0, 0, 0, 0, 1,  0, 0, 0, 0,   0,  0,  0,  0)

WFA = c(1,0, 1,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AFA = c(1,0, 1,1,0,0,0,  0, 0, 0, 0, 0,  1, 0, 0, 0,   0,  0,  0,  0)
BFA = c(1,0, 1,0,1,0,0,  0, 0, 0, 0, 0,  0, 1, 0, 0,   0,  0,  0,  0)
HFA = c(1,0, 1,0,0,1,0,  0, 0, 0, 0, 0,  0, 0, 1, 0,   0,  0,  0,  0)
OFA = c(1,0, 1,0,0,0,1,  0, 0, 0, 0, 0,  0, 0, 0, 1,   0,  0,  0,  0)

WFC = c(1,1, 1,0,0,0,0,  0, 0, 0, 0, 0,  0, 0, 0, 0,   0,  0,  0,  0)
AFC = c(1,1, 1,1,0,0,0,  0, 1, 0, 0, 0,  1, 0, 0, 0,   1,  0,  0,  0)
BFC = c(1,1, 1,0,1,0,0,  0, 0, 1, 0, 0,  0, 1, 0, 0,   0,  1,  0,  0)
HFC = c(1,1, 1,0,0,1,0,  0, 0, 0, 1, 0,  0, 0, 1, 0,   0,  0,  1,  0)
OFC = c(1,1, 1,0,0,0,1,  0, 0, 0, 0, 1,  0, 0, 0, 1,   0,  0,  0,  1)


cf_e_preX <- rbind('White Male Algebra'=WMA,  
                          'White Female Algebra'=WFA,
                          'Black Male Algebra'=BMA,  
                          'Black Female Algebra'=BFA,
                          'Asian Male Algebra'=AMA, 
                          'Asian Female Algebra'=AFA,
                          'Hispanic Male Algebra'=HMA, 
                          'Hispanic Female Algebra'=HFA,
                          'Other Male Algebra'=OMA,  
                          'Other Female Algebra'=OFA,
                          'White Male Calculus'=WMC,  
                          'White Female Calculus'=WFC,
                          'Black Male Calculus'=BMC,  
                          'Black Female Calculus'=BFC,
                          'Asian Male Calculus'=AMC, 
                          'Asian Female Calculus'=AFC,
                          'Hispanic Male Calculus'=HMC, 
                          'Hispanic Female Calculus'=HFC,
                          'Other Male Calculus'=OMC,  
                          'Other Female Calculus'=OFC)

contrast_preX_est <- pool_and_cov_diffwm(e_preX,cf_e_preX)
unique(contrast_preX_est$race)

contrast_preX_est$race <- factor(contrast_preX_est$race, levels = c("Black", "Hispanic", "Other", "Asian",    "White"))

ggplot(data=contrast_preX_est, aes(x=race, y=Q, group=gender, color=gender)) + geom_point(position = position_dodge(width=0.90)) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Pretest (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))
```

```{r}

contrast_postX_est$time <- "Post"
contrast_preX_est$time <- "Pre"
for_plot <- rbind(contrast_postX_est,contrast_preX_est)
for_plot$Time <- factor(for_plot$time, levels=c("Pre","Post")) 
for_plot$gender_time <- paste(for_plot$Time, for_plot$gender)
for_plot$gender_time <- factor(for_plot$gender_time, levels=c("Pre Female","Pre Male","Post Female","Post Male"))

ggplot(data=for_plot, aes(x=race, y=Q, group=gender_time, color=gender, shape=Time)) + geom_point(position = position_dodge(width=0.90), size=2) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Expert-like Score (%)") +
  scale_color_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) +
facet_grid(.~instruction, scales = "free", space = "free") +
  ylim(c(40,70))

```




```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$race_otherstar_no_int ==1, "Other","White"))))
desc <- temp %>% group_by(course_id) %>% summarise(N = length(e_pre),
                                                                 pre_mean = mean(e_pre),
                                                                 pre_sd = sd(e_pre),
                                                                 post_mean = mean(e_post),
                                                                 post_sd = sd(e_post),
                                                                 gain_mean_e = mean (e_post-e_pre),
                                                                 gain_mean_l = mean (l_post-l_pre),
                                                                 gain_sd = sd(e_post-e_pre)
                                                                 )


return <- desc
}
course_sum <- desc2 %>% group_by(course_id) %>% summarise_all(funs(mean))

ggplot(course_sum, aes(x=gain_mean_e,y=gain_mean_l)) + geom_point() + 
  geom_smooth() + 
  geom_abline(intercept =  0,slope =  1) +
  ggtitle("Course Mean CLASS Scores")

```

```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$race_otherstar_no_int ==1, "Other","White"))))
desc <- temp %>% group_by(course_id) %>% summarise(N = length(l_pre),
                                                                 pre_mean = mean(l_pre),
                                                                 pre_sd = sd(l_pre),
                                                                 post_mean = mean(l_post),
                                                                 post_sd = sd(l_post),
                                                                 gain_mean = mean (l_post-l_pre),
                                                                 gain_sd = sd(l_post-l_pre)
                                                                 )


return <- desc
}
course_sum <- desc2 %>% group_by(course_id) %>% summarise_all(funs(mean))

ggplot(course_sum, aes(x=pre_mean,y=post_mean)) + geom_point() + 
  geom_smooth() + 
  geom_abline(intercept =  0,slope =  1) +
  ggtitle("Course Mean CLASS Scores")

```




```{r}
load("as_courses")
load("all_class")
load("/Users/jnissen1/Documents/LASSO Data/LASSO_data_1_19")

temp <- unique(alldata_1_19[c(1:33,58,65)])
temp2 <- subset(temp, course_id %in% as_courses)
write.csv(temp2, file="course_descriptions")

courses <- unique(course_descriptions_updated[c(1:3)])

course_descriptions_updated <- read.csv("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/CLASS Analysis/course_descriptions_updated.csv")
courses <- unique(course_descriptions_updated[c(1:3)])
```


